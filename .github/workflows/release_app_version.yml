name: Flutter Multi-Platform Release & Version Management

on:
  workflow_dispatch:  # Manual trigger; add 'push: branches: [main]' for auto

permissions:
  contents: write  # For git commit/push in README update

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}  # For push permissions

      - name: Free up disk space  # FIX: Reclaims ~25 GB to prevent "No space left" error
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          android: false  # Skip to avoid conflicts with later SDK install
          tool-cache: false  # Skip to preserve Node/Python for Firebase/npm

      - name: Cache Android SDK/AVD  # FIX: Avoid redownloading ~5 GB images
        uses: actions/cache@v4
        with:
          path: |
            ~/.android
            $ANDROID_SDK_ROOT
          key: android-sdk-custom-path-api36-33-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            android-sdk-custom-path-api36-33-${{ runner.os }}-

      - name: Log free space  # DEBUG: Monitor space post-cleanup
        run: df -h

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Install dependencies  # NEW: Get Flutter pubs early
        run: flutter pub get

      - name: Generate Android debug keystore if missing
        run: |
          if [ ! -f ~/.android/debug.keystore ]; then
            mkdir -p ~/.android
            keytool -genkey -v -keystore ~/.android/debug.keystore -storepass android -keypass android -alias androiddebugkey -dname "CN=RareApps Debug,O=RareApps,C=IN" -keyalg RSA -keysize 2048 -validity 1
          fi
          echo "Debug keystore ensured."

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Enable KVM for Android Emulators
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Configure Android SDK Path  # ADD THIS
        run: |
          echo "ANDROID_SDK_ROOT=$GITHUB_WORKSPACE/android-sdk" >> $GITHUB_ENV
          mkdir -p "$ANDROID_SDK_ROOT"

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK Components  # OPTIMIZED: ARM64 for space savings; skip if cached
        run: |
          yes | sdkmanager --licenses || true
          # Use ARM64 images (smaller/faster on modern runners)
          sdkmanager "system-images;android-36;google_apis;arm64-v8a"
          sdkmanager "system-images;android-33;google_apis;arm64-v8a"
          sdkmanager "platform-tools" "emulator" "platforms;android-36" "platforms;android-33"

      - name: Create Pixel Tablet Emulator (API 36)  # UPDATED: ARM64 package
        run: |
          echo "no" | avdmanager create avd --force --name pixel_tablet_api_36 --package "system-images;android-36;google_apis;arm64-v8a" --device "pixel_tablet"
          cat >> ~/.android/avd/pixel_tablet_api_36.avd/config.ini << EOF
          hw.keyboard=yes
          hw.ramSize=4096
          hw.gpu.enabled=yes
          hw.gpu.mode=auto
          disk.dataPartition.size=4096M
          EOF

      - name: Create Pixel 8a Emulator (API 33)  # UPDATED: ARM64 package
        run: |
          echo "no" | avdmanager create avd --force --name pixel_8a_api_33 --package "system-images;android-33;google_apis;arm64-v8a" --device "pixel_8a"
          cat >> ~/.android/avd/pixel_8a_api_33.avd/config.ini << EOF
          hw.keyboard=yes
          hw.ramSize=2048
          hw.gpu.enabled=yes
          hw.gpu.mode=auto
          disk.dataPartition.size=2048M
          EOF

      - name: Set up Virtual Display (Xvfb) for Screenshots
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb libglu1-mesa imagemagick  # NEW: ImageMagick for post-processing
          Xvfb :99 -screen 0 1920x1080x24 &
          export DISPLAY=:99
          echo "DISPLAY=:99" >> $GITHUB_ENV
          sleep 2

      - name: Start Android Emulators  # OPTIMIZED: Sequential start to reduce peak load
        run: |
          # Start Tablet first
          $ANDROID_HOME/emulator/emulator -avd pixel_tablet_api_36 -no-snapshot-save -no-audio -no-boot-anim -gpu host -port 5554 &
          sleep 5  # Brief pause
          # Start Phone
          $ANDROID_HOME/emulator/emulator -avd pixel_8a_api_33 -no-snapshot-save -no-audio -no-boot-anim -gpu host -port 5556 &

      - name: Wait for Emulators to be Ready  # UNCHANGED: Solid logic
        run: |
          # Tablet
          adb -s emulator-5554 wait-for-device shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done'
          adb -s emulator-5554 shell settings put global window_animation_scale 0.0
          adb -s emulator-5554 shell settings put global transition_animation_scale 0.0
          adb -s emulator-5554 shell settings put global animator_duration_scale 0.0
          # Phone
          adb -s emulator-5556 wait-for-device shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done'
          adb -s emulator-5556 shell settings put global window_animation_scale 0.0
          adb -s emulator-5556 shell settings put global transition_animation_scale 0.0
          adb -s emulator-5556 shell settings put global animator_duration_scale 0.0
          adb devices -l

      - name: Install Firebase CLI
        run: |
          npm install -g firebase-tools@latest  # UPDATED: @latest for JDK 21 compat
          firebase --version

      - name: Set up Firebase Emulator Prerequisites  # OPTIMIZED: Cache-aware
        run: |
          mkdir -p ~/.cache/firebase/emulators
          firebase setup:emulators:firestore
          firebase setup:emulators:ui

      - name: Start Firebase Emulators  # UNCHANGED: Good curl check
        run: |
          firebase emulators:start --only auth,firestore --project wandrr-15f70 &
          for i in {1..120}; do
            if curl -s http://localhost:8080 > /dev/null 2>&1 && curl -s http://localhost:9099 > /dev/null 2>&1; then
              echo "Firebase emulators ready!"
              break
            fi
            sleep 1
          done
          echo "FIREBASE_EMULATOR_PID=$!" >> $GITHUB_ENV

      - name: Build & Install Flutter APK on Emulators  # SPLIT: Build once, install on both
        run: |
          flutter build apk --debug
          flutter install -s emulator-5554  # Tablet
          flutter install -s emulator-5556  # Phone

      - name: Cleanup Emulators & Firebase  # NEW: Graceful shutdown
        if: always()
        run: |
          adb -s emulator-5554 emu kill || true
          adb -s emulator-5556 emu kill || true
          pkill -f "firebase emulators" || true
          echo "Cleanup complete"
