name: Flutter Multi-Platform Release & Version Management

on:
  workflow_dispatch:  # Manual trigger; add 'push: branches: [main]' for auto

permissions:
  contents: write  # For git commit/push in README update

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}  # For push permissions

      - name: Free up disk space  # FIX: Reclaims ~25 GB to prevent "No space left" error
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          android: false  # Skip to avoid conflicts with later SDK install
          tool-cache: false  # Skip to preserve Node/Python for Firebase/npm

      - name: Cache Android SDK/AVD  # FIX: Avoid redownloading ~5 GB images
        uses: actions/cache@v4
        with:
          path: |
            ~/.android
            $ANDROID_SDK_ROOT
          key: android-sdk-custom-path-api36-33-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            android-sdk-custom-path-api36-33-${{ runner.os }}-

      - name: Log free space  # DEBUG: Monitor space post-cleanup
        run: df -h

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Install dependencies  # NEW: Get Flutter pubs early
        run: flutter pub get

      - name: Generate Android debug keystore if missing
        run: |
          if [ ! -f ~/.android/debug.keystore ]; then
            mkdir -p ~/.android
            keytool -genkey -v -keystore ~/.android/debug.keystore -storepass android -keypass android -alias androiddebugkey -dname "CN=RareApps Debug,O=RareApps,C=IN" -keyalg RSA -keysize 2048 -validity 1
          fi
          echo "Debug keystore ensured."

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Enable KVM for Android Emulators
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Configure Android SDK Path  # ADD THIS
        run: |
          echo "ANDROID_SDK_ROOT=$GITHUB_WORKSPACE/android-sdk" >> $GITHUB_ENV
          mkdir -p "$ANDROID_SDK_ROOT"

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK Components  # Use x86_64 to match host architecture
        run: |
          yes | sdkmanager --licenses || true
          # Use x86_64 images (required for x86_64 GitHub runners)
          sdkmanager "system-images;android-36;google_apis;x86_64"
          sdkmanager "system-images;android-33;google_apis;x86_64"
          sdkmanager "platform-tools" "emulator" "platforms;android-36" "platforms;android-33"

      - name: Set Android AVD Home  # NEW: Point emulator to correct AVD location
        run: |
          # Find where avdmanager actually creates AVDs
          ACTUAL_AVD_HOME="$HOME/.config/.android/avd"
          mkdir -p "$ACTUAL_AVD_HOME"
          echo "ANDROID_AVD_HOME=$ACTUAL_AVD_HOME" >> $GITHUB_ENV
          echo "Android AVD Home set to: $ACTUAL_AVD_HOME"

      - name: Create Pixel Tablet Emulator (API 36)  # x86_64 for host compatibility
        run: |
          echo "Creating Pixel Tablet AVD..."
          
          # Check if system image is installed
          echo "Verifying system image installation..."
          sdkmanager --list | grep "system-images;android-36;google_apis;x86_64"
          
          # List available devices
          echo "Available device definitions:"
          avdmanager list device | grep -i pixel
          
          # Create AVD and capture output
          set +e  # Don't exit on error yet
          AVD_OUTPUT=$(echo "no" | avdmanager create avd --force --name pixel_tablet_api_36 \
            --package "system-images;android-36;google_apis;x86_64" \
            --device "pixel_tablet" 2>&1)
          AVD_EXIT_CODE=$?
          set -e
          
          echo "$AVD_OUTPUT"
          
          if [ $AVD_EXIT_CODE -ne 0 ]; then
            echo "Error: avdmanager create avd failed with exit code $AVD_EXIT_CODE"
            echo "Trying with generic device profile instead..."
          
            # Fallback: Create with tablet dimensions manually
            echo "no" | avdmanager create avd --force --name pixel_tablet_api_36 \
              --package "system-images;android-36;google_apis;x86_64" \
              --device "pixel_tablet" --abi x86_64 || \
            echo "no" | avdmanager create avd --force --name pixel_tablet_api_36 \
              --package "system-images;android-36;google_apis;x86_64" \
              --device 30
          fi
          
          # Wait for filesystem sync
          sleep 3
          
          # Verify AVD was created and find its actual path
          AVD_INFO=$(avdmanager list avd | grep -A 5 "Name: pixel_tablet_api_36")
          AVD_DIR=$(echo "$AVD_INFO" | grep "Path:" | awk '{print $2}')
          
          if [ -z "$AVD_DIR" ] || [ ! -d "$AVD_DIR" ]; then
            echo "Error: Could not find AVD directory"
            echo "AVD Info:"
            avdmanager list avd
            exit 1
          fi
          
          echo "AVD directory found at: $AVD_DIR"
          
          # Append configuration to existing config.ini
          cat >> "$AVD_DIR/config.ini" << EOF
          hw.keyboard=yes
          hw.ramSize=4096
          hw.gpu.enabled=yes
          hw.gpu.mode=auto
          disk.dataPartition.size=4096M
          EOF
          
          echo "Pixel Tablet AVD created successfully"
          ls -la "$AVD_DIR"

      - name: Create Pixel 8a Emulator (API 33)  # x86_64 for host compatibility
        run: |
          echo "Creating Pixel 8a AVD..."
          
          # Check if system image is installed
          echo "Verifying system image installation..."
          sdkmanager --list | grep "system-images;android-33;google_apis;x86_64"
          
          # Create AVD and capture output
          set +e  # Don't exit on error yet
          AVD_OUTPUT=$(echo "no" | avdmanager create avd --force --name pixel_8a_api_33 \
            --package "system-images;android-33;google_apis;x86_64" \
            --device "pixel_8a" 2>&1)
          AVD_EXIT_CODE=$?
          set -e
          
          echo "$AVD_OUTPUT"
          
          if [ $AVD_EXIT_CODE -ne 0 ]; then
            echo "Error: avdmanager create avd failed with exit code $AVD_EXIT_CODE"
            echo "Trying with generic device profile instead..."
          
            # Fallback: Create with phone dimensions
            echo "no" | avdmanager create avd --force --name pixel_8a_api_33 \
              --package "system-images;android-33;google_apis;x86_64" \
              --device "pixel_8a" --abi x86_64 || \
            echo "no" | avdmanager create avd --force --name pixel_8a_api_33 \
              --package "system-images;android-33;google_apis;x86_64" \
              --device 30
          fi
          
          # Wait for filesystem sync
          sleep 3
          
          # Verify AVD was created and find its actual path
          AVD_INFO=$(avdmanager list avd | grep -A 5 "Name: pixel_8a_api_33")
          AVD_DIR=$(echo "$AVD_INFO" | grep "Path:" | awk '{print $2}')
          
          if [ -z "$AVD_DIR" ] || [ ! -d "$AVD_DIR" ]; then
            echo "Error: Could not find AVD directory"
            echo "AVD Info:"
            avdmanager list avd
            exit 1
          fi
          
          echo "AVD directory found at: $AVD_DIR"
          
          # Append configuration to existing config.ini
          cat >> "$AVD_DIR/config.ini" << EOF
          hw.keyboard=yes
          hw.ramSize=2048
          hw.gpu.enabled=yes
          hw.gpu.mode=auto
          disk.dataPartition.size=2048M
          EOF
          
          echo "Pixel 8a AVD created successfully"
          ls -la "$AVD_DIR"

      - name: Set up Virtual Display (Xvfb) for Screenshots
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb libglu1-mesa imagemagick libpulse0  # Added libpulse0 for emulator audio libs
          Xvfb :99 -screen 0 1920x1080x24 &
          export DISPLAY=:99
          echo "DISPLAY=:99" >> $GITHUB_ENV
          sleep 2

      - name: Start Android Emulators  # OPTIMIZED: Sequential start to reduce peak load
        run: |
          echo "ANDROID_AVD_HOME is: $ANDROID_AVD_HOME"
          echo "Available AVDs:"
          $ANDROID_HOME/emulator/emulator -list-avds
          echo "AVD directory contents:"
          ls -la "$ANDROID_AVD_HOME" || echo "Directory not accessible"
          
          # Start Tablet first
          $ANDROID_HOME/emulator/emulator -avd pixel_tablet_api_36 -no-snapshot-save -no-audio -no-boot-anim -gpu host -port 5554 &
          sleep 5  # Brief pause
          # Start Phone
          $ANDROID_HOME/emulator/emulator -avd pixel_8a_api_33 -no-snapshot-save -no-audio -no-boot-anim -gpu host -port 5556 &

      - name: Wait for Emulators to be Ready  # UNCHANGED: Solid logic
        run: |
          # Tablet
          adb -s emulator-5554 wait-for-device shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done'
          adb -s emulator-5554 shell settings put global window_animation_scale 0.0
          adb -s emulator-5554 shell settings put global transition_animation_scale 0.0
          adb -s emulator-5554 shell settings put global animator_duration_scale 0.0
          # Phone
          adb -s emulator-5556 wait-for-device shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done'
          adb -s emulator-5556 shell settings put global window_animation_scale 0.0
          adb -s emulator-5556 shell settings put global transition_animation_scale 0.0
          adb -s emulator-5556 shell settings put global animator_duration_scale 0.0
          adb devices -l

      - name: Install Firebase CLI
        run: |
          npm install -g firebase-tools@latest  # UPDATED: @latest for JDK 21 compat
          firebase --version

      - name: Set up Firebase Emulator Prerequisites  # OPTIMIZED: Cache-aware
        run: |
          mkdir -p ~/.cache/firebase/emulators
          firebase setup:emulators:firestore
          firebase setup:emulators:ui

      - name: Start Firebase Emulators  # UNCHANGED: Good curl check
        run: |
          firebase emulators:start --only auth,firestore --project wandrr-15f70 &
          for i in {1..120}; do
            if curl -s http://localhost:8080 > /dev/null 2>&1 && curl -s http://localhost:9099 > /dev/null 2>&1; then
              echo "Firebase emulators ready!"
              break
            fi
            sleep 1
          done
          echo "FIREBASE_EMULATOR_PID=$!" >> $GITHUB_ENV

      - name: Build & Install Flutter APK on Emulators  # SPLIT: Build once, install on both
        run: |
          flutter build apk --debug
          flutter install -s emulator-5554  # Tablet
          flutter install -s emulator-5556  # Phone

      - name: Cleanup Emulators & Firebase  # NEW: Graceful shutdown
        if: always()
        run: |
          adb -s emulator-5554 emu kill || true
          adb -s emulator-5556 emu kill || true
          pkill -f "firebase emulators" || true
          echo "Cleanup complete"
