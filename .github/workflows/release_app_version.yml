name: Flutter Multi-Platform Release & Version Management

on:
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Generate Android debug keystore if missing
        run: |
          if [ ! -f ~/.android/debug.keystore ]; then
            mkdir -p ~/.android
            keytool -genkey -v -keystore ~/.android/debug.keystore -storepass android -keypass android -alias androiddebugkey -dname "CN=RareApps Debug,O=RareApps,C=IN" -keyalg RSA -keysize 2048 -validity 1
          fi
          echo "Debug keystore ensured."

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Enable KVM for Android Emulators
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK Components
        run: |
          # Accept licenses
          yes | sdkmanager --licenses || true
          
          # Install system images for both emulators
          sdkmanager "system-images;android-36;google_apis;x86_64"
          sdkmanager "system-images;android-33;google_apis;x86_64"
          
          # Install platform tools and emulator
          sdkmanager "platform-tools"
          sdkmanager "emulator"
          sdkmanager "platforms;android-36"
          sdkmanager "platforms;android-33"

      - name: Create Pixel Tablet Emulator (API 36)
        run: |
          echo "Creating Pixel Tablet emulator..."
          echo "no" | avdmanager create avd \
            --force \
            --name pixel_tablet_api_36 \
            --package "system-images;android-36;google_apis;x86_64" \
            --device "pixel_tablet"
          
          # Configure emulator settings
          cat >> ~/.android/avd/pixel_tablet_api_36.avd/config.ini << EOF
          hw.keyboard=yes
          hw.ramSize=4096
          hw.gpu.enabled=yes
          hw.gpu.mode=auto
          disk.dataPartition.size=4096M
          EOF
          
          echo "Pixel Tablet emulator created successfully"

      - name: Create Pixel 8a Emulator (API 33)
        run: |
          echo "Creating Pixel 8a emulator..."
          echo "no" | avdmanager create avd \
            --force \
            --name pixel_8a_api_33 \
            --package "system-images;android-33;google_apis;x86_64" \
            --device "pixel_8a"
          
          # Configure emulator settings
          cat >> ~/.android/avd/pixel_8a_api_33.avd/config.ini << EOF
          hw.keyboard=yes
          hw.ramSize=2048
          hw.gpu.enabled=yes
          hw.gpu.mode=auto
          disk.dataPartition.size=2048M
          EOF
          
          echo "Pixel 8a emulator created successfully"

      - name: Set up Virtual Display (Xvfb) for Screenshots
        run: |
          # Install Xvfb for virtual display
          sudo apt-get update
          sudo apt-get install -y xvfb libglu1-mesa
          
          # Start Xvfb on display :99
          Xvfb :99 -screen 0 1920x1080x24 &
          export DISPLAY=:99
          echo "DISPLAY=:99" >> $GITHUB_ENV
          
          # Wait for Xvfb to be ready
          sleep 2
          echo "Virtual display ready for screenshots"

      - name: Start Android Emulators
        run: |
          # Start Pixel Tablet in background (with display for screenshots)
          echo "Starting Pixel Tablet emulator..."
          $ANDROID_HOME/emulator/emulator -avd pixel_tablet_api_36 \
            -no-snapshot-save \
            -no-audio \
            -no-boot-anim \
            -gpu swiftshader_indirect \
            -port 5554 &
          
          # Start Pixel 8a in background (with display for screenshots)
          echo "Starting Pixel 8a emulator..."
          $ANDROID_HOME/emulator/emulator -avd pixel_8a_api_33 \
            -no-snapshot-save \
            -no-audio \
            -no-boot-anim \
            -gpu swiftshader_indirect \
            -port 5556 &
          
          echo "Waiting for emulators to boot..."

      - name: Wait for Emulators to be Ready
        run: |
          # Wait for Pixel Tablet (emulator-5554)
          echo "Waiting for Pixel Tablet (emulator-5554) to boot..."
          adb -s emulator-5554 wait-for-device shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done'
          adb -s emulator-5554 shell settings put global window_animation_scale 0.0
          adb -s emulator-5554 shell settings put global transition_animation_scale 0.0
          adb -s emulator-5554 shell settings put global animator_duration_scale 0.0
          echo "✓ Pixel Tablet ready (emulator-5554)"
          
          # Wait for Pixel 8a (emulator-5556)
          echo "Waiting for Pixel 8a (emulator-5556) to boot..."
          adb -s emulator-5556 wait-for-device shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done'
          adb -s emulator-5556 shell settings put global window_animation_scale 0.0
          adb -s emulator-5556 shell settings put global transition_animation_scale 0.0
          adb -s emulator-5556 shell settings put global animator_duration_scale 0.0
          echo "✓ Pixel 8a ready (emulator-5556)"
          
          # List all devices
          echo "Available emulators:"
          adb devices -l

      - name: Install Firebase CLI
        run: |
          npm install -g firebase-tools
          firebase --version  # Verify

      - name: Set up Firebase Emulator Prerequisites
        run: |
          # Create necessary directories for emulator data
          mkdir -p ~/.cache/firebase/emulators
          
          # Download emulators if not cached
          firebase setup:emulators:firestore
          firebase setup:emulators:ui
          
          echo "Firebase emulator prerequisites set up successfully"

      - name: Start Firebase Emulators
        run: |
          # Start emulators in background
          firebase emulators:start --only auth,firestore --project wandrr-15f70 &
          
          # Wait for emulators to be ready (max 120 seconds)
          echo "Waiting for Firebase emulators to start..."
          for i in {1..120}; do
            if curl -s http://localhost:8080 > /dev/null 2>&1 && \
               curl -s http://localhost:9099 > /dev/null 2>&1; then
              echo "Firebase emulators are ready!"
              break
            fi
            if [ $i -eq 120 ]; then
              echo "Error: Firebase emulators failed to start within 60 seconds"
              exit 1
            fi
            sleep 1
          done
          
          # Keep emulators running for subsequent steps
          echo "FIREBASE_EMULATOR_PID=$!" >> $GITHUB_ENV

      - name: Build Flutter APK (Android)
        run: flutter build apk --debug
